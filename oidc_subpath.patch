Subject: [PATCH] oidc subpath redirection

---
 apps/web/src/app/platform/web-environment.service.ts | 3 +--
 apps/web/src/connectors/sso.ts                       | 6 +++---
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/apps/web/src/app/platform/web-environment.service.ts b/apps/web/src/app/platform/web-environment.service.ts
index 2b5ac93392..e801b8fe52 100644
--- a/apps/web/src/app/platform/web-environment.service.ts
+++ b/apps/web/src/app/platform/web-environment.service.ts
@@ -35,8 +35,7 @@ export class WebEnvironmentService extends DefaultEnvironmentService {
     //
     // We want to get to just `https://vaultwarden.example.com/base/path`.
     let baseUrl = this.win.location.href;
-    baseUrl = baseUrl.replace(/#.*/, ""); // Strip off `#` and everything after.
-    baseUrl = baseUrl.replace(/\/+$/, ""); // Trim any trailing `/` chars.
+    baseUrl = baseUrl.replace(/(\/+|\/*#.*|\/*\?.*)$/, ""); // Strip off trailing `/`, `#`, `?` and everything after.
     const urls = { base: baseUrl };
 
     // Find the region
diff --git a/apps/web/src/connectors/sso.ts b/apps/web/src/connectors/sso.ts
index e049c64e5d..a9fb7edb07 100644
--- a/apps/web/src/connectors/sso.ts
+++ b/apps/web/src/connectors/sso.ts
@@ -12,13 +12,13 @@ window.addEventListener("load", () => {
   } else if (state != null && state.includes(":clientId=browser")) {
     initiateBrowserSso(code, state, false);
   } else {
-    window.location.href = window.location.origin + "/#/sso?code=" + code + "&state=" + state;
+    const baseUrl = window.location.href.replace("/sso-connector.html", "");
     // Match any characters between "_returnUri='" and the next "'"
     const returnUri = extractFromRegex(state, "(?<=_returnUri=')(.*)(?=')");
     if (returnUri) {
-      window.location.href = window.location.origin + `/#${returnUri}`;
+      window.location.href = baseUrl + `/#${returnUri}`;
     } else {
-      window.location.href = window.location.origin + "/#/sso?code=" + code + "&state=" + state;
+      window.location.href = baseUrl + "/#/sso?code=" + code + "&state=" + state;
     }
   }
 });
-- 
2.39.2

